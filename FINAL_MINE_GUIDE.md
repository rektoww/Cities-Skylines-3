# 🎮 Полное руководство: Шахта, производство и продажа (ветка Finance)

## ✅ Что реализовано

### 1. **Шахта как строимое здание**
- **Класс**: `Core/Models/Buildings/IndustrialBuildings/Mine.cs`
- **Характеристики**:
  - Стоимость: **30 000 валюты**
  - Требует: 5 Steel + 8 Concrete
  - Размер: 2×2
  - Добывает случайный материал (Steel или Concrete)
  - Скорость: **3 единицы за тик**
  - Хранилище: **100 единиц**

### 2. **Строительство шахты**
- Выбрать в меню: **Производство → Шахта (⛏️)**
- Поставить на карте
- Списывается 30 000 + материалы

### 3. **Производство ресурсов**
- Кнопка **⏱️ Производство** симулирует тик производства
- Все шахты на карте добывают ресурсы
- Накапливаются в хранилище шахты (StoredResources)

### 4. **Сбор ресурсов**
- Кликнуть по тайлу с шахтой
- Показывается информация:
  - Добывает: Steel/Concrete
  - Накоплено: X/100
  - Скорость: 3 ед./тик
- Диалог: "Собрать X ед. Material?"
- При подтверждении → материалы переходят в инвентарь игрока

### 5. **Продажа материалов (диалоговое окно)**
- Кнопка **💰 Продать**
- Открывается диалог с выбором:
  - Каждый материал отдельной строкой
  - Показывается: доступно, цена за шт., итого
  - Можно указать количество для каждого материала
  - Общая выручка внизу
- При продаже:
  - Списываются материалы
  - Зачисляются деньги в бюджет
  - Записывается доход "Sale: Material xQty"

---

## 🎮 Полный сценарий игры

### Шаг 1: Построить шахту
1. Открыть меню **Производство**
2. Выбрать **Шахта** (⛏️)
3. Кликнуть на карте
4. **Результат**: -30 000 валюты, -5 Steel, -8 Concrete

### Шаг 2: Произвести ресурсы
1. Нажать **⏱️ Производство** несколько раз (симулировать время)
2. Шахта накапливает материалы (по 3 ед. за раз)
3. Максимум 100 ед. в хранилище

### Шаг 3: Собрать ресурсы
1. Кликнуть по шахте
2. Увидеть: "Накоплено: 15/100"
3. Подтвердить сбор
4. **Результат**: +15 материалов в инвентарь

### Шаг 4: Продать ресурсы
1. Нажать **💰 Продать**
2. В диалоге указать количество для продажи:
   - Steel: 10 шт. (цена 84 = 840 валюты)
   - Concrete: 5 шт. (цена 35 = 175 валюты)
3. Нажать "Продать"
4. **Результат**: +1015 валюты в бюджет

### Шаг 5: Построить что-то еще
1. Использовать заработанные деньги
2. Построить Парк (1000) или Магазин (50 000)

---

## 📊 Экономика

### Цены строительства
| Здание | Стоимость | Материалы |
|--------|-----------|-----------|
| Шахта | 30 000 | 5 Steel + 8 Concrete |
| Парк | 1 000 | нет |
| Магазин | 50 000 | 2 Steel + 3 Concrete + 2 Glass |

### Цены материалов
| Материал | Закупка | Продажа (70%) |
|----------|---------|---------------|
| Steel | 120 | 84 |
| Concrete | 50 | 35 |
| Glass | 80 | 56 |

### Расчет окупаемости шахты
- **Затраты на постройку**: 30 000 + (5×84 + 8×35) = **30 700** валюты (если продавать материалы)
- **Производство**: 3 ед./тик
- **Доход**: 3 × 84 = **252 валюты/тик** (если добывает Steel)
- **Окупаемость**: ~122 тика (или ~41 тик если материалы были свои)

---

## 🎨 UI элементы

### Кнопки в верхней панели
1. **⏱️ Производство** — симулировать производство на всех шахтах
2. **💰 Продать** — открыть диалог продажи материалов
3. **📦 Ресурсы** — показать инвентарь
4. **💵 (справа)** — показывает текущий бюджет, клик → финансовый отчет

### Диалог продажи материалов
```
┌────────────────────────────────────┐
│ Выберите материалы для продажи:    │
├────────────────────────────────────┤
│ Steel              [  10  ] = 840  │
│ Доступно: 15 шт.                   │
│ Цена: 84 за шт.                    │
├────────────────────────────────────┤
│ Concrete           [  5   ] = 175  │
│ Доступно: 10 шт.                   │
│ Цена: 35 за шт.                    │
├────────────────────────────────────┤
│ Общая выручка: 1,015 валюты        │
├────────────────────────────────────┤
│           [Продать]  [Отмена]      │
└────────────────────────────────────┘
```

### Информация о шахте (клик по тайлу)
```
Координаты: (10; 15)
Рельеф: Plain
Инфраструктура: нет
Здание: Шахта
--- Детали шахты ---
Добывает: Steel
Накоплено: 27/100
Скорость: 3 ед./тик
Размер: 2x2

[OK]

Собрать 27 ед. Steel?
[Yes] [No]
```

---

## 🔄 Архитектура

```
┌─────────────────┐
│  Mine Building  │ ← Строимое здание (IConstructable<Mine>)
└────────┬────────┘
         │
         │ ProduceResources() → StoredResources += 3
         │
         v
┌─────────────────────┐
│ CollectResources()  │ → Игрок кликает на шахту
└──────────┬──────────┘
           │
           v
┌─────────────────────────┐
│ PlayerResources         │ ← Инвентарь пополняется
│ .StoredMaterials[Steel]│
└──────────┬──────────────┘
           │
           v (игрок решает продать)
┌──────────────────────────┐
│ SellMaterialsDialog      │ ← Выбор количества
└──────────┬───────────────┘
           │
           v
┌──────────────────────────────┐
│ ResourceProductionService    │ ← TrySellMaterials()
│   → FinancialSystem.AddIncome│
│   → PlayerResources.Balance  │
└──────────────────────────────┘
```

---

## 📝 Новые файлы

| Файл | Описание |
|------|----------|
| `Core/Models/Buildings/IndustrialBuildings/Mine.cs` | Класс шахты |
| `Core/Services/ResourceProductionService.cs` | Сервис производства и продажи |
| `Laboratornaya3/Views/SellMaterialsDialog.xaml` | UI диалога продажи |
| `Laboratornaya3/Views/SellMaterialsDialog.xaml.cs` | Логика диалога |

---

## 🚀 Что дальше

### Краткосрочные улучшения
- [ ] **Автоматическое производство**: шахта работает каждые N секунд
- [ ] **Визуализация накопленных ресурсов**: циферка над шахтой (текст в UI)
- [ ] **Разные типы шахт**: железная руда, уголь, камень
- [ ] **Улучшения шахты**: увеличить скорость/хранилище

### Долгосрочные
- [ ] **Производственные цепочки**: руда → завод → сталь
- [ ] **Истощение месторождений**: шахта замедляется со временем
- [ ] **Автоматический сбор**: грузовики возят ресурсы с шахты на склад
- [ ] **Рынок с динамическими ценами**: цены меняются от спроса

---

## 🎉 Итого

### ✅ Работает полностью:
1. **Строительство шахты** через меню Производство
2. **Производство материалов** по кнопке (симуляция времени)
3. **Сбор ресурсов** кликом по шахте
4. **Продажа с выбором количества** через диалог
5. **Финансовый учет** — доходы/расходы записываются
6. **UI обновляется** — бюджет меняется в реальном времени

### 🎮 Готово к игре!
Поставьте несколько шахт, накопите материалы, продайте излишки, стройте город! 🏗️💰

---

## 🐛 Известные ограничения

1. **Производство ручное** — нужно нажимать кнопку (будущее: авто-тики)
2. **Нет визуализации ресурсов на карте** — циферка над шахтой (TODO)
3. **Случайный тип материала** — при постройке шахты определяется Steel/Concrete
4. **Нет истощения** — шахта работает бесконечно

Все это можно доработать в следующих итерациях! 🚀
